import {readSobazaar} from "../problems/sobazaar.problem";
import {fitnessScore, Score} from "../fitness";
import {calcRecursive} from "../evaluate";
import {hash} from "../utils/cache.utils";
import {readFSCache, writeFSCache} from "../utils/fs.utils";
import {ProblemInstance} from "../interface/problem.interface";
import {ConfigTree} from "../tree";

export const configsDensity = [
  // [`dense-0`, `{"config":{"type":"nearestNeighbour","N":21},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":5},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"nearestNeighbour","N":9},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"nearestNeighbour","N":14},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"nearestNeighbour","N":12},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"scaleMatrix","scale":3},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}]}`, `MRR@10=0.0241`],
  // [`dense-1`, `{"config":{"type":"nearestNeighbour","N":29},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour","N":18},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"scaleMatrix","scale":10},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}`, `MRR@10=0.0248`],
  // [`dense-2`, `{"config":{"type":"nearestNeighbour(inverted)","N":13},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":16},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":24},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}`, `MRR@10=0.025`],
  // [`dense-3`, `{"config":{"type":"nearestNeighbour","N":9},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":1},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}`, `MRR@10=0.0192`],
  // [`sparse-0`, `{"config":{"type":"nearestNeighbour","N":5},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":2},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"scaleMatrix","scale":6},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}`, `MRR@10=0.0165`],
  // [`sparse-1`, `{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"nearestNeighbour","N":8},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":4},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}`, `MRR@10=0.0168`],
  // [`sparse-2`, `{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}`, `MRR@10=0.0163`],
  // [`sparse-3`, `{"config":{"type":"nearestNeighbour(inverted)","N":16},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"scaleMatrix","scale":3},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour","N":26},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}`, `MRR@10=0.0202`],
  [`dense-0`, `{"config":{"type":"nearestNeighbour","N":21},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":5},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"nearestNeighbour","N":9},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"nearestNeighbour","N":14},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"nearestNeighbour","N":12},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"scaleMatrix","scale":3},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}]}`, `MRR@10=0.0241`],
  [`dense-1`, `{"config":{"type":"nearestNeighbour(inverted)","N":13},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":16},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":24},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}`, `MRR@10=0.025`],
  [`sparse-0`, `{"config":{"type":"nearestNeighbour","N":5},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":2},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"user","valueType":"number"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"scaleMatrix","scale":6},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}`, `MRR@10=0.0165`],
  [`sparse-1`, `{"config":{"type":"nearestNeighbour(inverted)","N":16},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(pixel-init)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"product"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"scaleMatrix","scale":3},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour","N":26},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}`, `MRR@10=0.0202`],
]

export const configsInteraction = [
  [`content:interact:product_detail_viewed`, `{"config":{"type":"nearestNeighbour","N":29},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":8},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":4},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"scaleMatrix","scale":7},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}]}`, `MRR@10=0.0601`],
  [`product_detail_clicked`, `{"config":{"type":"nearestNeighbour","N":26},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"nearestNeighbour","N":5},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":0},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"scaleMatrix","scale":2},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}`, `MRR@10=0.1316`],
  [`product_wanted`, `{"config":{"type":"nearestNeighbour","N":30},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"addVector"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour","N":11},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"popularity"},"output":{"dtoType":"vector","entity":"product","valueType":"number"},"input":[{"config":{"type":"interaction(content:interact:product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"nearestNeighbour","N":20},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(product_detail_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]},{"config":{"type":"interaction(product_wanted)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}`, `MRR@10=0.1717`],
  [`purchase:buy_clicked`, `{"config":{"type":"nearestNeighbour","N":6},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(content:interact:product_detail_viewed)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"scaleMatrix","scale":10},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]},{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"sumMatrix"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]},{"config":{"type":"interaction(content:interact:product_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[{"config":{"type":"nearestNeighbour(inverted)","N":11},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"nearestNeighbour(inverted)","N":20},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"pearsonSimilarity"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]},{"config":{"type":"transpose"},"output":{"dtoType":"matrix","fromEntity":"product","toEntity":"user"},"input":[{"config":{"type":"interaction(purchase:buy_clicked)"},"output":{"dtoType":"matrix","fromEntity":"user","toEntity":"product"},"input":[]}]}]}]}]}]}`, `MRR@10=0.019`],
]

const memoize = (problem: ProblemInstance, config: ConfigTree, fn: () => Score) => {
  const key = `results/${hash(problem, config)}`
  const cached = readFSCache(key)
  if (cached) {
    console.log(`Full program cache hit: ${key}`)
    return cached
  }

  const res = fn()
  // writeFSCache(key, res)

  return res
}

const mainDensity = async () => {
  const denseProblem = await readSobazaar(undefined, undefined, undefined, "dense")
  const sparseProblem = await readSobazaar(undefined, undefined, undefined, "sparse")

  const configs = configsDensity.map(([key, config, ...rest]) => [key, JSON.parse(config)])

  configs.forEach(([key, config]) => {
      const denseScore = memoize(denseProblem, config, () => fitnessScore(
        calcRecursive(config, denseProblem),
        denseProblem
      )).raw
      console.log(`{'dataset': 'sobazaar-dense', 'training': '${key}', 'mrr': ${denseScore.mrr}},`,)
    const sparseScore = memoize(sparseProblem, config, () => fitnessScore(
        calcRecursive(config, sparseProblem),
        sparseProblem
      )).raw
    console.log(`{'dataset': 'sobazaar-sparse', 'training': '${key}', 'mrr': ${sparseScore.mrr}},`,)
    }
  )
}

const mainInteraction = async () => {
  configsInteraction.forEach(async ([keyData, ...rest]) => {
    const denseProblem = await readSobazaar(undefined, undefined, keyData, "dense")
    configsInteraction.forEach(([keyConfig, configString, ...rest]) => {
      const config = JSON.parse(configString)
      const score = memoize(denseProblem, config, () => fitnessScore(
        calcRecursive(config, denseProblem),
        denseProblem
      ))
      console.log(`{'dataset': '${keyData}', 'training': '${keyConfig}', 'mrr': '${score.raw.mrr}'}`,)
    })
  })
}

mainDensity()
// mainInteraction()

